___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "JSON Client",
  "categories": ["ANALYTICS", "CONVERSIONS","MARKETING"],
  "brand": {
    "id": "github.com_floriangoetting",
    "displayName": "floriangoetting",
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": "The JSON Client receives JSON Payloads and makes the data available in the Event Data. The built-in ID Service creates long lasting server-side set (HTTP-Only) cookies for visitor identification.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "clientSettings",
    "displayName": "Client Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "requestPath",
        "displayName": "Request Path",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^/.*$"
            ]
          }
        ],
        "help": "Please define the Path under which you want the Endpoint to be available."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "cookieSettings",
    "displayName": "Cookie Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "GROUP",
        "name": "deviceIdCookieSettings",
        "displayName": "Device ID Cookie Settings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "setDeviceIdCookie",
            "checkboxText": "Set Device ID Cookie",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "deviceIdCookieEnableEventDataPath",
            "displayName": "Path to Event Data with Device ID Cookie Enablement Status",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "setDeviceIdCookie",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "help": "This field can contain the Path to Event Data which contains a boolean value to define dynamically if the Device ID Cookie should be set or not. For example this could be a consent boolean for a service for which this cookie is relevant. If no Event Data is specified, the Device ID Cookie will be set in any case."
          },
          {
            "type": "TEXT",
            "name": "deviceIdCookieName",
            "displayName": "Device ID Cookie Name",
            "simpleValueType": true,
            "help": "The Name of your server-side Device ID Cookie.",
            "enablingConditions": [
              {
                "paramName": "setDeviceIdCookie",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "defaultValue": "fp_device_id",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "deviceIdCookieLifetime",
            "displayName": "Device ID Cookie Lifetime (Days)",
            "simpleValueType": true,
            "defaultValue": 400,
            "help": "You can customize the number of days here how long you want the Device ID Cookie to live. The default value 400 is the maximum number of days for a cookie to live which is supported by Google Chrome.",
            "enablingConditions": [
              {
                "paramName": "setDeviceIdCookie",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": []
      },
      {
        "type": "GROUP",
        "name": "sessionIdCookieSettings",
        "displayName": "Session ID Cookie Settings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "setSessionIdCookie",
            "checkboxText": "Set Session ID Cookie",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "sessionIdCookieEnableEventDataPath",
            "displayName": "Path to Event Data with Session ID Cookie Enablement Status",
            "simpleValueType": true,
            "help": "This field can contain the Path to Event Data which contains a boolean value to define dynamically if the Session ID Cookie should be set or not. For example this could be a consent boolean for a service for which this cookie is relevant. If no Event Data is specified, the Session ID Cookie will be set in any case.",
            "enablingConditions": [
              {
                "paramName": "setSessionIdCookie",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "sessionIdCookieName",
            "displayName": "Session ID Cookie Name",
            "simpleValueType": true,
            "help": "The Name of your server-side Session ID Cookie.",
            "enablingConditions": [
              {
                "paramName": "setSessionIdCookie",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "defaultValue": "fp_session_id",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "sessionIdCookieLifetime",
            "displayName": "Session ID Cookie Lifetime (Minutes)",
            "simpleValueType": true,
            "defaultValue": 30,
            "help": "You can customize the number of minutes here how long you want the Session ID Cookie to live. With the default value of 30 minutes, the Session ID Cookie will be deleted and recreated if the visitor comes back to the site after 30 minutes of inactivity. If the visitor continues to browse through the site, the Session Cookie lifetime will be reset to the number of minutes again to retain the session.",
            "enablingConditions": [
              {
                "paramName": "setSessionIdCookie",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "generalCookieSettings",
        "displayName": "General Cookie Settings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "cookieDomain",
            "displayName": "Cookie Domain",
            "simpleValueType": true,
            "help": "The Domain on which you want to set your server-side Cookies. Usually this will be .yourdomain.com to include subdomains as well. If you leave the default value \"auto\" it will be automatically detected as the eTLD+1 of the first header found in the following priority order: 1. \u0027Forwarded\u0027, 2. \u0027X-Forwarded-Host\u0027, 3. \u0027Host\u0027.",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [],
            "defaultValue": "auto"
          },
          {
            "type": "TEXT",
            "name": "cookiePath",
            "displayName": "Cookie Path",
            "simpleValueType": true,
            "help": "You can specify a path here if you want the cookies only be sent on specific URL Paths. Normally this should be left with the default \"/\".",
            "defaultValue": "/",
            "enablingConditions": []
          },
          {
            "type": "CHECKBOX",
            "name": "cookieSecure",
            "checkboxText": "Set Secure Flag",
            "simpleValueType": true,
            "help": "With the secure flag enabled you make sure, that the cookies will only be set if the HTTPS protocol is beeing used.",
            "defaultValue": true,
            "enablingConditions": []
          },
          {
            "type": "CHECKBOX",
            "name": "cookieHttpOnly",
            "checkboxText": "Set HttpOnly Flag",
            "simpleValueType": true,
            "help": "With the HttpOnly Flag enabled, you make sure, that the cookies can not be read by javascript for example using document.cookie. If you need to read the cookie values in the client-side GTM, you can still read them from the Data Layer.",
            "defaultValue": true,
            "enablingConditions": []
          },
          {
            "type": "SELECT",
            "name": "cookieSameSite",
            "displayName": "SameSite Attribute",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "Lax",
                "displayValue": "Lax"
              },
              {
                "value": "Strict",
                "displayValue": "Strict"
              },
              {
                "value": "None",
                "displayValue": "None"
              }
            ],
            "simpleValueType": true,
            "help": "This attribute defines whether the cookies are sent with cross-site requests.",
            "defaultValue": "Lax",
            "enablingConditions": []
          }
        ],
        "enablingConditions": [
          {
            "paramName": "setDeviceIdCookie",
            "paramValue": true,
            "type": "EQUALS"
          },
          {
            "paramName": "setSessionIdCookie",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "corsSettings",
    "displayName": "CORS Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "enableCors",
        "checkboxText": "Enable CORS Headers",
        "simpleValueType": true,
        "help": "If your Tagging Server is served from a different domain or subdomain, you will need to configure the CORS Headers to make sure that the requests are not blocked. Please note that the CORS Headers will not work until you publish the ssGTM Container the first time with the setting enabled. You will also need to clear the browser cache and cookies after you published the ssGTM Container.",
        "defaultValue": false
      },
      {
        "type": "TEXT",
        "name": "allowedOrigins",
        "displayName": "Allowed Origins",
        "simpleValueType": true,
        "help": "Please enter a valid RegEx here to validate the origin. If the RegEx is not matched, the request will not be claimed. If you do not want to validate the origin, just leave the default value of \"*\".",
        "defaultValue": "*",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "monitoringSettings",
    "displayName": "Monitoring Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "monitorFailedTags",
        "checkboxText": "Monitor Failed Tags",
        "simpleValueType": true,
        "help": "When this option is activated, the JSON Client will listen for failed tags and will create a monitor event when at least one of the tags failed. You can send additional data like the request and response from the tags to the JSON Client which will be included in the event. For more information about this, please check the documentation in Github: https://github.com/floriangoetting/json-client.",
        "defaultValue": false
      },
      {
        "type": "CHECKBOX",
        "name": "monitorSuccessfulTags",
        "checkboxText": "Monitor Successful Tags",
        "simpleValueType": true,
        "defaultValue": false,
        "help": "When this option is activated, the JSON Client will listen for successful tags and will create a monitor event when at least one of the tags suceeded. You can send additional data like the request and response from the tags to the JSON Client which will be included in the event. For more information about this, please check the documentation in Github: https://github.com/floriangoetting/json-client.",
        "subParams": []
      },
      {
        "type": "TEXT",
        "name": "monitorEventName",
        "displayName": "Monitor Event Name",
        "simpleValueType": true,
        "help": "You can customize the name of the monitor event here. The default event name is \"server_monitor\".",
        "defaultValue": "server_monitor",
        "enablingConditions": [
          {
            "paramName": "monitorFailedTags",
            "paramValue": true,
            "type": "EQUALS"
          },
          {
            "paramName": "monitorSuccessfulTags",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "sendMonitorEventWithoutCustomData",
        "displayName": "Send Monitor Event also if no custom Monitor Data is provided",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "onlyFailedTags",
            "displayValue": "Only Failed Tags"
          },
          {
            "value": "onlySuccessfulTags",
            "displayValue": "Only Successful Tags"
          },
          {
            "value": "failedAndSuccessfulTags",
            "displayValue": "Failed and Successful Tags"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "onlyFailedTags",
        "help": "You can specify here, if the Monitoring Event should be sent as well if no custom Monitor Data had been provided through the send message \"server_monitor\" API Call from your server tags.\n\nSee https://github.com/floriangoetting/json-client/tree/main for more details about this feature.",
        "enablingConditions": [
          {
            "paramName": "monitorFailedTags",
            "paramValue": true,
            "type": "EQUALS"
          },
          {
            "paramName": "monitorSuccessfulTags",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const makeString = require('makeString');
const makeInteger = require('makeInteger');
const claimRequest = require('claimRequest');
const returnResponse = require('returnResponse');
const getRequestBody = require('getRequestBody');
const addEventCallback = require('addEventCallback');
const runContainer = require('runContainer');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');
const setResponseBody = require('setResponseBody');
const getRequestHeader = require('getRequestHeader');
const getRequestPath = require('getRequestPath');
const getRequestMethod = require('getRequestMethod');
const getRequestQueryParameters = require('getRequestQueryParameters');
const generateRandom = require('generateRandom');
const getTimestamp = require('getTimestamp');
const logToConsole = require('logToConsole');
const Object = require('Object');
const JSON = require('JSON');
const getType = require('getType');
const parseUrl = require('parseUrl');
const createRegex = require('createRegex');
const testRegex = require('testRegex');
const addMessageListener = require('addMessageListener');

const requestParams = getRequestQueryParameters();
const origin = getRequestHeader('origin') || (!!getRequestHeader('referer') && parseUrl(getRequestHeader('referer')).origin) || requestParams.origin;
const UA = getRequestHeader('user-agent');
const HOST = getRequestHeader('host');

const requestPath = getRequestPath();

let responseData = {};
let monitorData = false;

const log = msg => {
  logToConsole('[JSON Client] ' + msg);
};

const validateOrigin = () => {
  // if no origin is present, skip origin validation
  if(!origin){
    return true;
  }
  const allowedOriginsRegEx = createRegex(data.allowedOrigins, 'i');
  return data.allowedOrigins === '*' || (allowedOriginsRegEx !== null && testRegex(allowedOriginsRegEx, origin));
};

// check if client should claim the request
if (requestPath === data.requestPath) {
  if (!validateOrigin()) {
    log('Request originated from invalid origin');
    return;
  }
  // claim the request
  claimRequest();
} else {
  return;
}

const payloadToEvent = (payload) => {
  const event = JSON.parse(payload);
  if (getType(event) === 'object' && getType(event.data) === 'array') {
    return { events: event.data };
  }
  return event;
};

const addCommonEventData = (event) => {
  event.ip_override = require('getRemoteAddress')();
  if(origin){
    event.origin = origin;
  }
  event.host = HOST;
  event.user_agent = UA;
  
  return event;
};

// Function to generate a UUID v4 without crypto and without regex
const generateUUIDv4 = () => {
  let uuid = '';
  const hexDigits = '0123456789abcdef';

  for (let i = 0; i < 36; i++) {
    if (i === 14) {
      uuid += '4'; // UUID Version 4
    } else if (i === 19) {
      uuid += (8 + generateRandom(0, 3)).toString(16);
    } else if (i === 8 || i === 13 || i === 18 || i === 23) {
      uuid += '-';
    } else {
      uuid += hexDigits[generateRandom(0, 15)];
    }
  }
  return uuid;
};

let setOrUpdateCookie = (cookieName, domain, cookiePath, cookieSecure, cookieHttpOnly, cookieSameSite, duration, value) => { 
    // Retrieve the existing cookie value
    const existingCookieValues = getCookieValues(cookieName);
    const existingCookie = existingCookieValues.length > 0 ? existingCookieValues[0] : null;

    // Generate a new UUID if no existing cookie
    const cookieValue = existingCookie || value;

    // Set the cookie
    setCookie(cookieName, cookieValue, {
        'max-age': duration,
        'domain': domain,
        'path': cookiePath,
        'secure': cookieSecure,
        'httpOnly': cookieHttpOnly,
        'sameSite': cookieSameSite
    });
    
    return cookieValue;
};

const sendResponse = (statusCode) => {
  // Prevent CORS errors
  if (data.enableCors) {
    setResponseHeader('Access-Control-Allow-Origin', origin);
    setResponseHeader('Access-Control-Allow-Credentials', 'true');
    setResponseHeader(
      'Access-Control-Allow-Headers',
      'Content-Type, Content-Encoding, Accept-Encoding'
    );
    setResponseHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  }
  setResponseHeader('Content-Type', 'application/json;charset=UTF-8');
  setResponseStatus(statusCode || 200);
  
  // set response body
  if(statusCode == 200){
    if (Object.keys(responseData).length === 0) {
      setResponseBody(JSON.stringify({ status: 'ok' })); 
    } else {
      setResponseBody(JSON.stringify(responseData));
    }
  }
  
  returnResponse();
};

const getValueByPath = (obj, path) => {
  const parts = path.split('.');
  let current = obj;
  for (let i = 0; i < parts.length; i++) {
    if (current === undefined || current === null) {
      return undefined;
    }
    current = current[parts[i]];
  }
  return current;
};

// handle the request
let event;
const domain = data.cookieDomain;
const cookiePath = data.cookiePath;
const cookieSecure = data.cookieSecure;
const cookieHttpOnly = data.cookieHttpOnly;
const cookieSameSite = data.cookieSameSite;
const deviceIdCookieName = data.deviceIdCookieName;
const deviceIdCookieLifetime = data.deviceIdCookieLifetime;
const sessionIdCookieName = data.sessionIdCookieName;
const sessionIdCookieLifetime = data.sessionIdCookieLifetime;
// handle the various request methods
const requestMethod = getRequestMethod();
if (requestMethod === 'POST') {
  event = payloadToEvent(getRequestBody());
  // Set device cookie
  if (data.setDeviceIdCookie) {
    const deviceIdCookieEnabled = data.deviceIdCookieEnableEventDataPath ? getValueByPath(event, data.deviceIdCookieEnableEventDataPath) : true;

    if (deviceIdCookieEnabled) {
      const eventClientId = event.client_id;
      
      // Only set cookie if NO client-side value was sent
      if(!eventClientId) {
        event.client_id = setOrUpdateCookie(
          deviceIdCookieName,
          domain,
          cookiePath,
          cookieSecure,
          cookieHttpOnly,
          cookieSameSite,
          makeInteger(deviceIdCookieLifetime) * 24 * 60 * 60,
          generateUUIDv4()
        );
      }
      // set response
      responseData.device_id = event.client_id;
    }
  }

  // set session cookie
  if(data.setSessionIdCookie){
    const sessionIdCookieEnabled = data.sessionIdCookieEnableEventDataPath ? getValueByPath(event, data.sessionIdCookieEnableEventDataPath) : true;
    
    if(sessionIdCookieEnabled) {
      const eventSessionId = event.session_id;
      
      // Only set cookie if NO client-side value was sent
      if(!eventSessionId) {
        event.session_id = setOrUpdateCookie(
          sessionIdCookieName,
          domain,
          cookiePath,
          cookieSecure,
          cookieHttpOnly,
          cookieSameSite,
          makeInteger(sessionIdCookieLifetime) * 60,
          makeString(getTimestamp())
        );
      }
      // set response
      responseData.session_id = event.session_id;
    }
  }
  // add common event data
  event = addCommonEventData(event);
  // run mapping
  if (event) {
    runContainer(event,
                 /* onComplete= */ (bindToEvent) => {
      sendResponse(200);
      // server monitor event
      if ((data.monitorFailedTags || data.monitorSuccessfulTags) && event.event_name !== data.monitorEventName) {
        bindToEvent(addEventCallback)((containerId, eventData) => {
          const tags = eventData.tags.filter(tag => tag.exclude !== 'true');
          const fTags = tags.filter(tag => tag.status === 'failure');
          const sTags = tags.filter(tag => tag.status === 'success');

          const sendEventWithoutCustomData = data.sendMonitorEventWithoutCustomData;
          const customMonitorDataCheckFailures = !monitorData && sendEventWithoutCustomData == 'onlySuccessfulTags' ? false : true;
          const shouldMonitorFailures = data.monitorFailedTags && fTags.length > 0 && customMonitorDataCheckFailures;
          const customMonitorDataCheckSuccesses = !monitorData && sendEventWithoutCustomData == 'onlyFailedTags' ? false : true;
          const shouldMonitorSuccesses = data.monitorSuccessfulTags && sTags.length > 0 && customMonitorDataCheckSuccesses;

          if (shouldMonitorFailures || shouldMonitorSuccesses) {
            const monitorEvent = event;
            monitorEvent.event_name = data.monitorEventName;
            monitorEvent.monitor = {};

            if (data.monitorFailedTags && fTags.length > 0) {
              monitorEvent.monitor.failed_tags = fTags;
            }
            if (data.monitorSuccessfulTags && sTags.length > 0) {
              monitorEvent.monitor.successful_tags = sTags;
            }
            if (monitorData) {
              monitorEvent.monitor.services = monitorData;
            }

            runContainer(monitorEvent, () => {
              // log('Monitor Event Fired:', monitorEvent);
            });
          } else {
            // log('No monitor event fired – no relevant tags.');
          }
        });
      }
    }, /* onStart= */ (bindToEvent) => {
      // listener for tag data for response
      bindToEvent(addMessageListener)('send_response', (messageType, message) => {
        if (!responseData.tags) {
          responseData.tags = {};
        }

        const keys = Object.keys(message);
        if (keys.length > 0) {
          const tag = keys[0];
          responseData.tags[tag] = message[tag];
        }
      });
      if(data.monitorFailedTags || data.monitorSuccessfulTags){
        // listener for monitor data
        bindToEvent(addMessageListener)('server_monitor', (messageType, message) => {
          if(!monitorData){
            monitorData = [];
          }

          monitorData.push(message);
        });
      }
    });
  }
} else if (requestMethod === 'OPTIONS') {
  sendResponse(204);
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "use_message",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedActions",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Set Device and Session Cookie
  code: |-
    const mockData = {
      "cookieDomain":"auto",
      "enableCors":false,
      "cookieHttpOnly":true,
      "deviceIdCookieName":"fp_device_id",
      "sessionIdCookieName":"fp_session_id",
      "cookieSecure":true,
      "allowedOrigins":"*",
      "setDeviceIdCookie":true,
      "cookieSameSite":"Lax",
      "setSessionIdCookie":true,
      "cookiePath":"/",
      "requestPath":"/data"
    };

    // Call runCode to run the template's code.
    runCode(mockData);


___NOTES___

Created on 24.9.2021, 21:46:20


